#!/bin/sh
# boot hook to enlarge the third (persistence) partition on live
# sticks to the actual size limit of the physical medium
# (for partition layout generated by FSFW stick-install.sh)

Grow_persistence()
{
	PART2=$(grep -m 1 findiso /proc/mounts | cut -f 1 -d ' ')
	DEV=$(readlink /sys/class/block/${PART2#/dev/})
	DEV=${DEV%/*}
	DEV=/dev/${DEV##*/}

	if [ -b ${DEV}*3 ] && LANG=C sfdisk --list-free ${DEV} | grep -qs "Start"
	then
		# grow persistence partition to device boundary
		echo ",+" | sfdisk --no-reread -N 3 ${DEV}
		partx --verbose --delete --nr 3 ${DEV}
		partx --verbose --add --nr 3 ${DEV}
		resize.f2fs ${DEV}*3
	fi
}
